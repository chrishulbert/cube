<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube solver</title>
    <link rel="stylesheet" href="modern-normalize.min.css">
    <link rel="icon" href="favicon.png">
</head>
<body>
<nav>
    <h1>Cube solver!</h1>
    <div>
        <button id="help">Help</button>
        <button id="solve">Solve</button>
    </div>
</nav>
<section id="cube-section" class="cube">
    <div class="cube-container">
        <table>
            <tr>
                <td colspan="3"></td>
                <td id="sq_u0" class="facelet t l"></td>
                <td id="sq_u1" class="facelet t"></td>
                <td id="sq_u2" class="facelet t r"></td>
            </tr>
            <tr>
                <td colspan="3"></td>
                <td id="sq_u3" class="facelet l"></td>
                <td id="sq_u4" class="facelet">Up</td>
                <td id="sq_u5" class="facelet r"></td>
            </tr>
            <tr>
                <td colspan="3"></td>
                <td id="sq_u6" class="facelet b l"></td>
                <td id="sq_u7" class="facelet b"></td>
                <td id="sq_u8" class="facelet b r"></td>
            </tr>
            <tr>
                <td id="sq_l0" class="facelet t l"></td>
                <td id="sq_l1" class="facelet t"></td>
                <td id="sq_l2" class="facelet t r"></td>
                <td id="sq_f0" class="facelet t l"></td>
                <td id="sq_f1" class="facelet t"></td>
                <td id="sq_f2" class="facelet t r"></td>
                <td id="sq_r0" class="facelet t l"></td>
                <td id="sq_r1" class="facelet t"></td>
                <td id="sq_r2" class="facelet t r"></td>
                <td id="sq_b0" class="facelet t l"></td>
                <td id="sq_b1" class="facelet t"></td>
                <td id="sq_b2" class="facelet t r"></td>
            </tr>
            <tr>
                <td id="sq_l3" class="facelet l"></td>
                <td id="sq_l4" class="facelet">Left</td>
                <td id="sq_l5" class="facelet r"></td>
                <td id="sq_f3" class="facelet l"></td>
                <td id="sq_f4" class="facelet">Front</td>
                <td id="sq_f5" class="facelet r"></td>
                <td id="sq_r3" class="facelet l"></td>
                <td id="sq_r4" class="facelet">Right</td>
                <td id="sq_r5" class="facelet r"></td>
                <td id="sq_b3" class="facelet l"></td>
                <td id="sq_b4" class="facelet">Back</td>
                <td id="sq_b5" class="facelet r"></td>
            </tr>
            <tr>
                <td id="sq_l6" class="facelet b l"></td>
                <td id="sq_l7" class="facelet b"></td>
                <td id="sq_l8" class="facelet b r"></td>
                <td id="sq_f6" class="facelet b l"></td>
                <td id="sq_f7" class="facelet b"></td>
                <td id="sq_f8" class="facelet b r"></td>
                <td id="sq_r6" class="facelet b l"></td>
                <td id="sq_r7" class="facelet b"></td>
                <td id="sq_r8" class="facelet b r"></td>
                <td id="sq_b6" class="facelet b l"></td>
                <td id="sq_b7" class="facelet b"></td>
                <td id="sq_b8" class="facelet b r"></td>
            </tr>
            <tr>
                <td colspan="3"></td>
                <td id="sq_d0" class="facelet t l"></td>
                <td id="sq_d1" class="facelet t"></td>
                <td id="sq_d2" class="facelet t r"></td>

            </tr>
            <tr>
                <td colspan="3"></td>
                <td id="sq_d3" class="facelet l"></td>
                <td id="sq_d4" class="facelet">Down</td>
                <td id="sq_d5" class="facelet r"></td>
            </tr>
            <tr>
                <td colspan="3"></td>
                <td id="sq_d6" class="facelet b l"></td>
                <td id="sq_d7" class="facelet b"></td>
                <td id="sq_d8" class="facelet b r"></td>
            </tr>
        </table>
    </div>
    <div class="palette">
        <div id="palette-white" class="facelet sq-white"></div>
        <div id="palette-green" class="facelet sq-green"></div>
        <div id="palette-red" class="facelet sq-red"></div>
        <div id="palette-blue" class="facelet sq-blue"></div>
        <div id="palette-yellow" class="facelet sq-yellow"></div>
        <div id="palette-orange" class="facelet sq-orange"></div>
    </div>
</section>
</body>
<style>
html {
    height: 100%;
    font-family: Superclarendon, 'Bookman Old Style', 'URW Bookman', 'URW Bookman L', 'Georgia Pro', Georgia, serif;
    font-weight: normal;
}
body {
    min-height: 100%;
    display: flex;
    flex-direction: column;
    background-color: #dfd;
}
nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-grow: 0;
    padding: 0 1em;
}
button {
    color: #fff;
    background: #77f;
    padding: 1em;
    border-radius: 1em;
    border: 1px solid rgba(0, 0, 0, 0.5);
    margin-left: 0.5em;
}
button:hover {
    background: #66e;
}
button:active {
    background: #44c;
}
section.cube {
    background-color: #ddf;
    flex-grow: 1;
    position: relative;
}
section.cube .cube-container {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}
table {
    border-collapse: collapse;
}
.palette {
    position: absolute;
    bottom: 0;
    right: 0;
    display: flex;
    flex-direction: row;
    justify-content: flex-end;
    align-items: flex-start;
    border: 1px solid black;
}
.facelet {
    background-color: gray;
    border: 1px solid black;
    text-align: center;
    font-size: 0.8rem;
}
.facelet.t {
    border-top: 5px solid black;
}
.facelet.l {
    border-left: 5px solid black;
}
.facelet.r {
    border-right: 5px solid black;
}
.facelet.b {
    border-bottom: 5px solid black;
}
.facelet.sq-white {
    background-color: white;
}
.facelet.sq-red {
    background-color: red;
}
.facelet.sq-green {
    background-color: green;
}
.facelet.sq-blue {
    background-color: blue;
}
.facelet.sq-yellow {
    background-color: yellow;
}
.facelet.sq-orange {
    background-color: orange;
}
.facelet.selected {
     border: 5px dashed black;
}
.face.up {
    border-top: 1px solid black;
    border-left: 1px solid black;
    border-right: 1px solid black;
}
.face.left {
    border-left: 1px solid black;
}
.face.right {
    border-right: 1px solid black;
}
.face.down {
    border-left: 1px solid black;
    border-right: 1px solid black;
}
.face.back {
    border-left: 1px solid black;
    border-right: 1px solid black;
    border-bottom: 1px solid black;
}
.face.up .row:last-child .square {
    border-bottom: 0;
}
.facesrow.triple {
    border-top: 1px solid black;
    border-bottom: 1px solid black;
}
.face.down .row:first-child .square {
    border-top: 0;
}
</style>
<style id="facelet-size-style">
.facelet {
    width: 2em;
    height: 2em;
}
</style>
<script type="module">
import min2phase from './min2phase.js'

const ColourWhite = 1
const ColourGreen = 2
const ColourRed = 3
const ColourBlue = 4
const ColourYellow = 5
const ColourOrange = 6
const upColour = ColourWhite
const leftColour = ColourGreen
const frontColour = ColourRed
const rightColour = ColourBlue
const downColour = ColourYellow
const backColour = ColourOrange

function classForColour(colour) {
    if (colour == ColourWhite) { return "sq-white" }
    if (colour == ColourGreen) { return "sq-green" }
    if (colour == ColourRed) { return "sq-red" }
    if (colour == ColourBlue) { return "sq-blue" }
    if (colour == ColourYellow) { return "sq-yellow" }
    if (colour == ColourOrange) { return "sq-orange" }
}
function hashCharForColour(colour) {
    if (colour == ColourWhite) { return "w" }
    if (colour == ColourGreen) { return "g" }
    if (colour == ColourRed) { return "r" }
    if (colour == ColourBlue) { return "b" }
    if (colour == ColourYellow) { return "y" }
    if (colour == ColourOrange) { return "o" }
}
function colourForHashChar(char) {
    if (char == "w") { return ColourWhite }
    if (char == "g") { return ColourGreen }
    if (char == "r") { return ColourRed }
    if (char == "b") { return ColourBlue }
    if (char == "y") { return ColourYellow }
    if (char == "o") { return ColourOrange }
    return undefined
}
function descriptionForColour(colour) {
    if (colour == ColourWhite) { return "White" }
    if (colour == ColourGreen) { return "Green" }
    if (colour == ColourRed) { return "Red" }
    if (colour == ColourBlue) { return "Blue" }
    if (colour == ColourYellow) { return "Yellow" }
    if (colour == ColourOrange) { return "Orange" }
}
const allColourClasses = [
    classForColour(ColourWhite),
    classForColour(ColourGreen),
    classForColour(ColourRed),
    classForColour(ColourBlue),
    classForColour(ColourYellow),
    classForColour(ColourOrange),
]
const centerSquareIndex = 4
class Face {
    id = ''
    colours = [] // 9 entries: top then mid then bottom rows.
    constructor(id, colour) {
        this.id = id
        this.colours = [colour, colour, colour, colour, colour, colour, colour, colour, colour]
    }
    applyToDom() {
        for (let i=0; i<9; i++) {
            this.setClass(this.element(i), this.colours[i])
        }
    }
    applyIndexToDom(index) {
        this.setClass(this.element(index), this.colours[index])
    }
    element(index) {
        return document.getElementById(`sq_${this.id}${index}`)
    }
    setClass(element, colour) {
        for (const c of allColourClasses) {
            element.classList.remove(c)
        }
        element.classList.add(classForColour(colour))
    }
    addEventListeners() {
        for (let i=0; i<9; i++) {
            this.element(i).addEventListener('mousedown', e => {
                this.onMouse(i, e.target)
            })
        }
    }
    onMouse(index, element) {
        if (index == centerSquareIndex) {
            alert('Due to the internal structure of the cube, these squares at the center of a face cannot change colour')
            return
        }
        this.colours[index] = currentlySelectedColour
        this.applyIndexToDom(index)
        cube.setFragment()
    }
}
class Faces {
    up = new Face('u', upColour)
    left = new Face('l', leftColour)
    front = new Face('f', frontColour)
    right = new Face('r', rightColour)
    down = new Face('d', downColour)
    back = new Face('b', backColour)
    all() {
        return [
            this.up,
            this.left,
            this.front,
            this.right,
            this.down,
            this.back,
        ]
    }
    applyToDom() {
        this.all().forEach(e => e.applyToDom())
    }
    addEventListeners() {
        this.all().forEach(e => e.addEventListeners())
    }
}
class Cube {
    faces = new Faces()
    constructor() {
        if (window.location.hash) {
            const slice = window.location.hash.slice(1)
            Array.from(slice || '').forEach((c, i) => {
                const colour = colourForHashChar(c)
                if (colour) {
                    const faceIndex = Math.trunc(i / 8)
                    let squareIndex = i % 8
                    if (squareIndex >= centerSquareIndex) { squareIndex += 1 }
                    this.faces.all()[faceIndex].colours[squareIndex] = colour
                }
            })
        }
    }
    applyToDom() {
        this.faces.applyToDom()
    }
    addEventListeners() {
        this.faces.addEventListeners()
    }
    setFragment() {
        let hash = ''
        for (const f of this.faces.all()) {
            f.colours.forEach((c, i) => {
                if (i != centerSquareIndex) {
                    hash += hashCharForColour(c)
                }
            })
        }
        window.location.hash = hash
    }
}
function addOrRemoveCssClass(element, klass, shouldAdd) {
    if (shouldAdd) {
        element.classList.add(klass)
    } else {
        element.classList.remove(klass)
    }
}
function applySelectedPaletteToDom() {
    addOrRemoveCssClass(document.getElementById('palette-white'), 'selected', currentlySelectedColour == ColourWhite)
    addOrRemoveCssClass(document.getElementById('palette-green'), 'selected', currentlySelectedColour == ColourGreen)
    addOrRemoveCssClass(document.getElementById('palette-red'), 'selected', currentlySelectedColour == ColourRed)
    addOrRemoveCssClass(document.getElementById('palette-blue'), 'selected', currentlySelectedColour == ColourBlue)
    addOrRemoveCssClass(document.getElementById('palette-yellow'), 'selected', currentlySelectedColour == ColourYellow)
    addOrRemoveCssClass(document.getElementById('palette-orange'), 'selected', currentlySelectedColour == ColourOrange)
}
function onSelectPalette(colour) {
    currentlySelectedColour = colour
    applySelectedPaletteToDom()
}
let currentlySelectedColour = ColourWhite
const cube = new Cube()
function onDomContentLoaded() {
    cube.addEventListeners()
    cube.applyToDom()

    // Listen to palette taps.
    applySelectedPaletteToDom()
    document.getElementById('palette-white').addEventListener('mousedown', e => onSelectPalette(ColourWhite))
    document.getElementById('palette-green').addEventListener('mousedown', e => onSelectPalette(ColourGreen))
    document.getElementById('palette-red').addEventListener('mousedown', e => onSelectPalette(ColourRed))
    document.getElementById('palette-blue').addEventListener('mousedown', e => onSelectPalette(ColourBlue))
    document.getElementById('palette-yellow').addEventListener('mousedown', e => onSelectPalette(ColourYellow))
    document.getElementById('palette-orange').addEventListener('mousedown', e => onSelectPalette(ColourOrange))

    // Size it accordingly. Pity this couldn't be done in CSS.
    new ResizeObserver(entries => {
        const contentSize = entries[0].contentBoxSize[0]
        const width = contentSize.inlineSize
        const height = contentSize.blockSize
        const squareSizeToFitVertically = height / 9
        const squareSizeToFitHorizontally = width / 12
        const size = Math.min(squareSizeToFitVertically, squareSizeToFitHorizontally)
        const rule = document.getElementById('facelet-size-style').sheet.cssRules[0]
        rule.style.setProperty('width', `${size}px`)
        rule.style.setProperty('height', `${size}px`)
    }).observe(document.getElementById('cube-section'))

    document.getElementById('help').addEventListener('click', e => help())
    document.getElementById('solve').addEventListener('click', e => solve())
}
document.addEventListener("DOMContentLoaded", onDomContentLoaded)
function help() {
    alert(
        `Firstly, orient your cube so the ${descriptionForColour(frontColour)} center faces you, with the ${descriptionForColour(upColour)} center upwards.\n` +
        'Then, select each colour on the bottom right, and paint the cube to match what you see.\n' +
        'Lastly, click solve, and follow the instructions to get your lousy stinking frustrating cube back to normal!!! ;-)\n' +
        'If you get an error while solving, check all the colours are correct, or perhaps your cube has been twisted to be unsolvable.'
    )
}
function solve() {
    // Min2phase expects cube input in the format "UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB".
    function min2phaseFaceFromColour(colour) {
        if (colour == upColour) { return "U" }
        if (colour == leftColour) { return "L" }
        if (colour == frontColour) { return "F" }
        if (colour == rightColour) { return "R" }
        if (colour == downColour) { return "D" }
        if (colour == backColour) { return "B" }
    }
    function colourFromMin2phaseFacelet(facelet) {
        if (facelet == "U") { return upColour }
        if (facelet == "L") { return leftColour }
        if (facelet == "F") { return frontColour }
        if (facelet == "R") { return rightColour }
        if (facelet == "D") { return downColour }
        if (facelet == "B") { return backColour }
        return undefined
    }
    function min2phaseFacesFromColours(colours) {
        return colours.map(c => min2phaseFaceFromColour(c)).join('')
    }
    const up = min2phaseFacesFromColours(cube.faces.up.colours)
    const front = min2phaseFacesFromColours(cube.faces.front.colours)
    const left = min2phaseFacesFromColours(cube.faces.left.colours)
    const right = min2phaseFacesFromColours(cube.faces.right.colours)
    const down = min2phaseFacesFromColours(cube.faces.down.colours)
    const back = min2phaseFacesFromColours(cube.faces.back.colours)
    const all = up + right + front + down + left + back
    const rawSolution = min2phase.solve(all).trim()
    const solution = rawSolution.split(' ').filter(m => m.length).map(move => {
        const colour = colourFromMin2phaseFacelet(move[0])
        if (!colour) { return move }
        let suffix = '↻'
        if (move[1] === "'") {
            suffix = '↺'
        } else if (move[1] === '2') {
            suffix = '180°'
        }
        return descriptionForColour(colour) + '-centered face ' + suffix
    }).join('\n')
    console.log(solution)
    console.log(rawSolution)
    alert(`Solution:\n${solution}\nDone!\n(${rawSolution})`)
}
</script>
<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0fcdd4c95bde44c698c47527902fe5fd"}'></script><!-- End Cloudflare Web Analytics -->
</html>
